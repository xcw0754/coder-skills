# fork剖析


创建进程所用的接口最后都会调用`do_fork`系统调用，而`do_fork`中基本就是在复制当前进程的`task_struct`(很复杂的那个结构体，称为pcb)，并初始化其中一些值。

1. copy_files 拷贝打开的文件描述符
2. copy_mm 拷贝内存，其实就是复制个结构体而已


拷贝内存时，CLONE_VM这个flag决定了是创建线程还是进程，线程就共享同一地址空间，共享同个`mm_struct`结构体。进程的话就要创建新的结构体，为每个可写的VMA置`VM_DENYWRITE`标志来实现copy-on-write。总而言之，通过fork创建进程的时候，复制并初始化了一些结构体，不会拷贝整个进程空间。Redis利用了这一点实现可吃久化的，即创建一个新的进程将数据写盘。
